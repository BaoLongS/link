function link(e,t){"use strict";function n(e){return!!e&&"object"==typeof e}function r(e){return!!e&&"object"==typeof e&&"number"==typeof e.length}function i(e,t){for(var n=e.length,r=-1;++r<n;)t.call(e,e[r],r,e)}function o(e){return P.test(e)}function c(e,t){this.watch=e,this.arr=t}function u(e){if(e)for(var t,n=[];t=M.exec(e);)n.push(t[1]);return n}function a(e){var t=e.tpl;return i(e.prop,function(e){t="$"!==e[0]?t.replace(new RegExp("{{"+e+"}}","g"),v(e)):t.replace(new RegExp("{{\\"+e+"}}","g"),v(e))}),t}function p(e){var t=e.expr;return i(e.prop,function(e){var n=v(e);"string"==typeof n&&(n=["'",n,"'"].join("")),t="$"!==e[0]?t.replace(new RegExp(e,"g"),n):t.replace(new RegExp("\\"+e,"g"),n)}),g(t)}function l(e,t,n,r){this.el=e,this.prop=t,this.directive=n,this.tpl=r}function s(e){var t,n,r=[];return e.getAttribute?i(q,function(c){if(t=e.getAttribute(c))if(o(t))r.push(c),n=l.create(e,t,c),T.push(n),f(n),"x-model"===c&&d(n);else{var u=[];i(F,function(e){t.indexOf(e)>-1&&u.push(e)}),r.push(c),n=l.create(e,u,c),n.expr=t,T.push(n),f(n)}}):3===e.nodeType&&(r.push("x-bind"),t=u(e.textContent),t.length>0&&(n=l.create(e,t,"x-bind",e.textContent),T.push(n),f(n))),r}function f(e){r(e.prop)?i(e.prop,function(t){B[t]||(B[t]=[]),B[t].push(m(e))}):(B[e.prop]||(B[e.prop]=[]),B[e.prop].push(m(e)))}function d(e){var t=e.el;e.directive;"INPUT"===t.nodeName?"text"===t.type?t.addEventListener("keyup",function(){x(e.prop,t.value||"")},!1):"radio"===t.type&&t.addEventListener("change",function(){x(e.prop,t.value||"")},!1):"SELECT"===t.nodeName&&t.addEventListener("change",function(){x(e.prop,t.value||"")},!1)}function h(e){var t;if(e.$$child)console.log("this is a clone x-repeat, skip compile");else if(t=s(e),t.indexOf("x-repeat")>-1)return void console.log("this is x-repeat, stop childNodes compile");i(e.childNodes,function(e){h(e)})}function v(e){try{var t=R;if(e){e=e.split(".");for(var n=e.length,r=0;r<n;r++)t=t[e[r]]}return t}catch(i){}}function x(e,t){var n=R;if(e){e=e.split(".");var r=e.length;if(1===r)return void(R[e]=t);for(var i=0;i<r;i++)if(n=n[e[i]],i===r-2)return void(n[e[r-1]]=t)}}function m(e){return function(){if("x-bind"!==e.directive||e.prop instanceof Array)if("x-model"===e.directive)e.el.value=v(e.prop);else if(e.prop instanceof Array){if(e.tpl)e.el.textContent=a(e);else if(e.expr){var t=p(e);"x-show"===e.directive&&y(e,t)}}else"x-repeat"===e.directive&&$(e);else e.el.innerText=v(e.prop)}}function g(e){var t=new Function("return "+e+";");try{return t.call()}catch(n){}}function y(e,t){var n=e.el;t?n.className.indexOf("x-hide")>-1&&(n.className=n.className.replace(/x-hide/g,"")):n.className.indexOf("x-hide")===-1&&(n.className=n.className+" x-hide")}function $(e){var t=v(e.prop),n=t&&t.arr,o=e.el;o&&(e.originEl=e.originEl||o.cloneNode(!0),e.comment=document.createComment("repeat end for "+e.prop),o.parentNode.insertBefore(e.comment,o),o.remove(),delete e.el);var c=e.lastLinks||[];c.length>0&&(i(c,function(e){e.unlink()}),c.length=0,c=[]),r(n)&&(i(n,function(t){var n=e.originEl.cloneNode(!0);n.$$child=!0,c.push(link(n,{$item:t})),e.comment.parentNode.insertBefore(n,e.comment)}),e.lastLinks=c)}function w(e){var t=B[e];t&&i(t,function(e){e.apply()})}function E(){for(var e in B)w(e)}function b(e,t){return t?t.push(e):t=[e],t.join(".")}function N(e,t,n,r,i){var o=b(t,r);F.push(o),i?e[t]=new c(o,n):Object.defineProperty(e,t,{get:function(){return n},set:function(e){e!==n&&(n=e,w(o))}})}function k(e,t){t=t||[];var o,c=Object.keys(e);i(c,function(i){o=e[i],n(o)&&!r(o)?(t.push(i),k(o,t),t.pop()):N(e,i,o,t.slice(0),r(o))})}function j(){if(!document.$$linkStyleLoaded){document.$$linkStyleLoaded=!0;var e=document.createElement("style");e.type="text/css",e.id="linkStyle",e.textContent=".x-hide{display:none !important;}",document.head.insertAdjacentElement("afterBegin",e)}}function L(){j(),k(R),h(e),E()}function O(t,n){R=t,n===!0&&(ar=[],h(e)),k(R),E()}function A(){console.log(R.$item+" unlinking"),R=null,T=null,B=null,e.$$child&&(e.remove(),e=null)}function C(e,t){t=t||{};var r,o=Object.keys(e);i(o,function(i){r=e[i],r instanceof c?t[i]=r.getArray():n(r)?(t[i]={},C(r,t[i])):t[i]=e[i]})}function S(){var e={};return C(R,e),e}if(!e||!t)throw Error("el and data are required!");if(!n(t))throw Error("data must be object");var R=t,T=[],B=Object.create(null),M=/\{\{(\$?[^\}]+)\}\}/g,P=/^\$?\w+(\.?\w+)*$/,q=["x-bind","x-model","x-repeat","x-show","x-hide"],F=[];return c.prototype=[],c.prototype.notify=function(){w(this.watch,this.arr),console.log(this.watch+":"+this.arr.toString())},c.prototype.getArray=function(){return this.arr.slice(0)},i(["push","pop","unshift","shift","reverse","sort","splice"],function(e){c.prototype[e]=function(){this.arr[e].apply(this.arr,arguments);this.notify()}}),l.create=function(e,t,n,r){return new l(e,t,n,r)},L(),{setModel:O,unlink:A,getModel:S,$model:R}}